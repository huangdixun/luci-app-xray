name: Build luci-app-xray

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrt Version'
        required: true
        default: '24.10.5'
        type: choice
        options:
          - '24.10.5'
          - '25.12.0-rc3'

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: source
      
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-distutils python3-pyelftools rsync unzip zlib1g-dev file wget zstd
      
      - name: Set SDK URL and package extension
        id: sdk
        run: |
          if [[ "${{ inputs.openwrt_version }}" == "24.10.5" ]]; then
            echo "url=https://downloads.openwrt.org/releases/24.10.5/targets/rockchip/armv8/openwrt-sdk-24.10.5-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst" >> $GITHUB_OUTPUT
            echo "ext=ipk" >> $GITHUB_OUTPUT
          else
            echo "url=https://downloads.openwrt.org/releases/25.12.0-rc3/targets/rockchip/armv8/openwrt-sdk-25.12.0-rc3-rockchip-armv8_gcc-14.3.0_musl.Linux-x86_64.tar.zst" >> $GITHUB_OUTPUT
            echo "ext=apk" >> $GITHUB_OUTPUT
          fi
      
      - name: Download OpenWrt SDK
        run: |
          wget ${{ steps.sdk.outputs.url }}
      
      - name: Extract SDK
        run: |
          tar --use-compress-program=unzstd -xf *.tar.zst
          SDK_DIR=$(find . -maxdepth 1 -type d -name "openwrt-sdk-*" | head -n 1)
          if [ -n "$SDK_DIR" ]; then
            mv "$SDK_DIR" openwrt-sdk
          else
            echo "Error: SDK directory not found"
            exit 1
          fi
      
      - name: Copy source to SDK
        run: |
          cp -r source openwrt-sdk/package/luci-app-xray
      
      - name: Update feeds
        run: |
          cd openwrt-sdk
          ./scripts/feeds update -a
          ./scripts/feeds install -a
      
      - name: Configure
        run: |
          cd openwrt-sdk
          echo "CONFIG_PACKAGE_luci-app-xray=m" >> .config
          make defconfig V=s
      
      - name: Build
        run: |
          cd openwrt-sdk
          make package/luci-app-xray/compile V=s -j$(nproc) || make package/luci-app-xray/compile V=s -j1
      
      - name: Find and collect packages
        run: |
          mkdir -p output
          find openwrt-sdk/bin -type f \( -name "luci-app-xray*.${{ steps.sdk.outputs.ext }}" -o -name "luci-i18n-xray*.${{ steps.sdk.outputs.ext }}" \) -exec cp {} output/ \;
          echo "Collected packages:"
          ls -lh output/
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-xray-${{ inputs.openwrt_version }}
          path: output/*
